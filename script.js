// Variables globals
let currentFlashcard = 0;
let isFlipped = false;
let currentSubject = null;
let allSubjectsData = {};
let currentNotes = {
    past: [],
    current: [],
    write: ''
};
let currentThemes = [];

// Inicialitzar quan es carregui la p√†gina
document.addEventListener('DOMContentLoaded', function() {
    loadDataFromStorage();
    initializeApp();
    loadSampleNotes();
});

// Funcions de persist√®ncia de dades
function saveDataToStorage() {
    try {
        localStorage.setItem('estudixpert_data', JSON.stringify(allSubjectsData));
        console.log('Dades guardades correctament');
    } catch (error) {
        console.error('Error guardant dades:', error);
    }
}

function loadDataFromStorage() {
    try {
        const savedData = localStorage.getItem('estudixpert_data');
        if (savedData) {
            allSubjectsData = JSON.parse(savedData);
            console.log('Dades carregades correctament');
        } else {
            allSubjectsData = {};
            console.log('No hi ha dades guardades, inicialitzant...');
        }
    } catch (error) {
        console.error('Error carregant dades:', error);
        allSubjectsData = {};
    }
}

function getSubjectData(subjectName) {
    if (!allSubjectsData[subjectName]) {
        allSubjectsData[subjectName] = {
            notes: {
                past: [],
                current: []
            },
            themes: []
        };
    }
    return allSubjectsData[subjectName];
}

function initializeApp() {
    // Configurar esdeveniments
    setupFlashcards();
    setupSubjectCards();
    setupAudioCards();
    setupFloatingAssistant();
    setupSettingsButton();
    setupSubjectDetail();
    setupAIChat();
    
    // Configurar missatges motivacionals
    startMotivationalMessages();
}

// Configurar pantalla d'assignatura
function setupSubjectDetail() {
    // Crear pantalla d'assignatura
    const subjectDetail = document.createElement('div');
    subjectDetail.className = 'subject-detail';
    subjectDetail.innerHTML = `
        <div class="subject-header">
            <h1 class="subject-title"></h1>
            <button class="close-btn" onclick="closeSubjectDetail()">‚úï Tancar</button>
        </div>
        <div class="subject-content">
            <div class="notes-section">
                <h3>üìù Apunts</h3>
                <div class="notes-tabs">
                    <button class="tab-btn active" onclick="switchTab('notes')">Apunts</button>
                    <button class="tab-btn" onclick="switchTab('themes')">Temes</button>
                    <button class="tab-btn" onclick="switchTab('write')">Escriure apunts</button>
                </div>
                <div class="tab-content active" id="notes-tab">
                    <div class="notes-list" id="notes-list"></div>
                </div>
                <div class="tab-content" id="themes-tab">
                    <div class="themes-list" id="themes-list"></div>
                </div>
                <div class="tab-content" id="write-tab">
                    <div class="write-section">
                        <label for="theme-select">Tema:</label>
                        <select class="theme-select" id="theme-select">
                            <option value="">Sense tema</option>
                        </select>
                    </div>
                    <textarea class="note-editor" placeholder="Escriu els teus apunts aqu√≠..."></textarea>
                    <button class="flip-btn" onclick="saveNote()">üíæ Guardar apunt</button>
                    <div class="ocr-section">
                        <h4>üì∑ Llegir text d'una imatge</h4>
                        <div class="ocr-upload" onclick="document.getElementById('image-input').click()">
                            <input type="file" id="image-input" accept="image/*" onchange="processImage(event)">
                            <p>üì∏ Clica per pujar una imatge i extreure el text</p>
                        </div>
                        <div id="ocr-result" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>
            <div class="ai-chat">
                <h3>ü§ñ Assistent IA S√öPER INTEL¬∑LIGENT</h3>
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai">
                        <p>üß† Hola! S√≥c la teva IA d'estudi COMPLETAMENT REPROGRAMADA i S√öPER INTEL¬∑LIGENT! 
                        
‚ú® NOVA FUNCIONALITAT:
‚Ä¢ Analitzo TOTS els teus apunts i temes
‚Ä¢ Genero resums NOM√âS del teu contingut
‚Ä¢ Creo preguntes basades en els teus estudis
‚Ä¢ NO m'invento res - nom√©s treballo amb les teves dades

üéØ Pots demanar-me:
‚Ä¢ "Fes un resum del tema 1 i 2"
‚Ä¢ "Genera preguntes d'examen"
‚Ä¢ "Explica [concepte dels teus apunts]"
‚Ä¢ "Crea exercicis de [tema]"

Com et puc ajudar amb els teus estudis?</p>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" placeholder="Pregunta'm sobre els teus apunts..." onkeypress="handleChatKeyPress(event)">
                    <button class="photo-btn" onclick="document.getElementById('ai-image-input').click()" title="Pujar foto">üì∑</button>
                    <input type="file" id="ai-image-input" accept="image/*" style="display: none;" onchange="processAIImage(event)">
                    <button class="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(subjectDetail);
}

// Configurar chat IA
function setupAIChat() {
    // Funcionalitat del chat ja implementada a setupSubjectDetail
}

// Configurar flashcards
function setupFlashcards() {
    const flipBtn = document.querySelector('.flip-btn');
    const knowBtn = document.querySelector('.know-btn');
    const studyBtn = document.querySelector('.study-btn');
    const flashcard = document.querySelector('.flashcard');
    
    if (flipBtn) {
        flipBtn.addEventListener('click', () => {
            flashcard.classList.toggle('flipped');
            isFlipped = !isFlipped;
        });
    }
    
    if (knowBtn) {
        knowBtn.addEventListener('click', () => {
            showFeedback('Excel¬∑lent! üéâ', 'success');
            nextFlashcard();
        });
    }
    
    if (studyBtn) {
        studyBtn.addEventListener('click', () => {
            showFeedback('Molt b√© per recon√®ixer-ho! üí™', 'info');
            nextFlashcard();
        });
    }
}

// Configurar targetes d'assignatures
function setupSubjectCards() {
    const subjectCards = document.querySelectorAll('.subject-card');
    
    subjectCards.forEach(card => {
        card.addEventListener('click', () => {
            const subject = card.querySelector('h3').textContent;
            openSubjectDetail(subject);
        });
    });
}

// Obrir pantalla d'assignatura
function openSubjectDetail(subject) {
    currentSubject = subject;
    const subjectDetail = document.querySelector('.subject-detail');
    const subjectTitle = document.querySelector('.subject-title');
    
    subjectTitle.textContent = subject;
    subjectDetail.classList.add('active');
    
    // Carregar dades espec√≠fiques de l'assignatura
    const subjectData = getSubjectData(subject);
    currentNotes = subjectData.notes;
    currentThemes = subjectData.themes;
    
    // Carregar apunts de l'assignatura
    loadSubjectNotes(subject);
    
    showFeedback(`Obrint ${subject}... üìñ`, 'info');
}

// Tancar pantalla d'assignatura
function closeSubjectDetail() {
    const subjectDetail = document.querySelector('.subject-detail');
    subjectDetail.classList.remove('active');
    currentSubject = null;
}

// Canviar pestanya
function switchTab(tabName) {
    // Actualitzar botons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Actualitzar contingut
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Carregar selector de temes si estem a la pestanya d'escriure
    if (tabName === 'write') {
        loadThemeSelector();
    }
}

// Carregar selector de temes
function loadThemeSelector() {
    const themeSelect = document.querySelector('.theme-select');
    if (!themeSelect) return;
    
    themeSelect.innerHTML = '<option value="">Sense tema</option>';
    
    currentThemes.forEach(theme => {
        const option = document.createElement('option');
        option.value = theme.id;
        option.textContent = `${theme.name} - ${theme.description}`;
        themeSelect.appendChild(option);
    });
}

// Carregar apunts d'exemple
function loadSampleNotes() {
    currentNotes = {
        past: [
            {
                id: 'note1',
                date: '2024-01-15',
                title: 'Introducci√≥ a l\'√†lgebra',
                content: 'Variables, expressions algebraiques, operacions b√†siques...',
                theme: 'tema1'
            },
            {
                id: 'note2',
                date: '2024-01-20',
                title: 'Equacions de primer grau',
                content: 'Resoluci√≥ d\'equacions, m√®todes de substituci√≥...',
                theme: 'tema1'
            }
        ],
        current: [
            {
                id: 'note3',
                date: '2024-01-25',
                title: 'Teorema de Pit√†gores',
                content: 'a¬≤ + b¬≤ = c¬≤ en triangles rectangles, aplicacions pr√†ctiques...',
                theme: 'tema2'
            }
        ],
        write: ''
    };
    
    // Carregar temes d'exemple
    currentThemes = [
        {
            id: 'tema1',
            name: 'TEMA 1',
            description: '√Älgebra b√†sica',
            color: '#ff7043'
        },
        {
            id: 'tema2',
            name: 'TEMA 2',
            description: 'Geometria',
            color: '#29b6f6'
        }
    ];
}

// Carregar apunts d'assignatura
function loadSubjectNotes(subject) {
    const notesContainer = document.getElementById('notes-list');
    const themesContainer = document.getElementById('themes-list');
    
    if (!notesContainer || !themesContainer) return;
    
    // Assegurar que currentNotes est√† inicialitzat
    if (!currentNotes) {
        currentNotes = { past: [], current: [], write: '' };
    }
    if (!currentNotes.past) currentNotes.past = [];
    if (!currentNotes.current) currentNotes.current = [];
    
    // Combinar tots els apunts
    const allNotes = [...currentNotes.past, ...currentNotes.current];
    
    // Mostrar tots els apunts
    notesContainer.innerHTML = '';
    if (allNotes.length === 0) {
        notesContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hi ha apunts encara. Comen√ßa a escriure!</p>';
    } else {
        allNotes.forEach(note => {
            const noteElement = document.createElement('div');
            noteElement.className = 'note-item';
            noteElement.innerHTML = `
                <div class="note-date">${note.date}</div>
                <div class="note-preview">${note.title}</div>
                <div class="note-actions">
                    <button class="delete-note-btn" onclick="deleteNote('${note.id}')">üóëÔ∏è</button>
                </div>
            `;
            noteElement.addEventListener('click', () => viewNote(note));
            notesContainer.appendChild(noteElement);
        });
    }
    
    // Mostrar temes
    loadThemes(themesContainer);
}

// Visualitzar apunt
function viewNote(note) {
    showFeedback(`Obrint: ${note.title}`, 'info');
    
    // Crear modal per visualitzar apunt
    const modal = document.createElement('div');
    modal.className = 'note-viewer-modal';
    modal.innerHTML = `
        <div class="note-viewer-content">
            <div class="note-viewer-header">
                <div class="note-info">
                    <h2 class="note-viewer-title">üìù ${note.title}</h2>
                    <p class="note-viewer-date">üìÖ ${note.date}</p>
                </div>
                <button class="note-close-btn" onclick="closeModal()">
                    <span>‚úï</span>
                </button>
            </div>
            <div class="note-viewer-body">
                <div class="note-content-display">
                    ${note.content.replace(/\n/g, '<br>')}
                </div>
            </div>
            <div class="note-viewer-footer">
                <button class="note-action-btn edit-btn" onclick="editNote('${note.id}')">
                    ‚úèÔ∏è Editar
                </button>
                <button class="note-action-btn delete-btn" onclick="deleteNoteFromViewer('${note.id}')">
                    üóëÔ∏è Eliminar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Afegir event listener per tancar amb clic fora
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeModal();
        }
    });
}

// Tancar modal
function closeModal() {
    const modal = document.querySelector('.note-viewer-modal');
    if (modal) {
        document.body.removeChild(modal);
    }
}

// Guardar apunt
function saveNote() {
    const noteEditor = document.querySelector('.note-editor');
    const themeSelect = document.querySelector('.theme-select');
    const noteContent = noteEditor.value.trim();
    
    if (!noteContent) {
        showFeedback('Escriu alguna cosa abans de guardar!', 'error');
        return;
    }
    
    const newNote = {
        id: 'note_' + Date.now(),
        date: new Date().toISOString().split('T')[0],
        title: noteContent.substring(0, 50) + (noteContent.length > 50 ? '...' : ''),
        content: noteContent,
        theme: themeSelect ? themeSelect.value : null
    };
    
    currentNotes.current.push(newNote);
    
    // Guardar a l'assignatura espec√≠fica
    if (currentSubject) {
        const subjectData = getSubjectData(currentSubject);
        subjectData.notes = currentNotes;
        subjectData.themes = currentThemes;
        saveDataToStorage();
    }
    
    noteEditor.value = '';
    
    showFeedback('Apunt guardat correctament! üìù', 'success');
    
    // Recarregar apunts
    loadSubjectNotes(currentSubject);
}

// Carregar temes
function loadThemes(container) {
    container.innerHTML = '';
    
    // Assegurar que currentThemes est√† inicialitzat
    if (!currentThemes) {
        currentThemes = [];
    }
    
    if (currentThemes.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No hi ha temes creats encara.</p>';
    } else {
        currentThemes.forEach(theme => {
            const themeElement = document.createElement('div');
            themeElement.className = 'theme-item';
            themeElement.style.borderLeft = `4px solid ${theme.color}`;
            themeElement.innerHTML = `
                <div class="theme-name">${theme.name}</div>
                <div class="theme-description">${theme.description}</div>
                <div class="theme-actions">
                    <button class="edit-theme-btn" onclick="editTheme('${theme.id}')">‚úèÔ∏è</button>
                    <button class="delete-theme-btn" onclick="deleteTheme('${theme.id}')">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(themeElement);
        });
    }
    
    // Bot√≥ per crear nou tema
    const addThemeBtn = document.createElement('div');
    addThemeBtn.className = 'add-theme-btn';
    addThemeBtn.innerHTML = `
        <div onclick="createNewTheme()">
            ‚ûï Crear nou tema
        </div>
    `;
    container.appendChild(addThemeBtn);
}

// Crear nou tema
function createNewTheme() {
    const themeName = prompt('Nom del tema (ex: TEMA 3):');
    const themeDescription = prompt('Descripci√≥ del tema:');
    
    if (!themeName || !themeDescription) return;
    
    const colors = ['#ff7043', '#29b6f6', '#ffa726', '#ab47bc', '#66bb6a', '#ef5350'];
    const randomColor = colors[Math.floor(Math.random() * colors.length)];
    
    const newTheme = {
        id: 'tema_' + Date.now(),
        name: themeName,
        description: themeDescription,
        color: randomColor
    };
    
    currentThemes.push(newTheme);
    
    // Guardar a l'assignatura espec√≠fica
    if (currentSubject) {
        const subjectData = getSubjectData(currentSubject);
        subjectData.themes = currentThemes;
        subjectData.notes = currentNotes;
        saveDataToStorage();
    }
    
    showFeedback('Tema creat correctament! üéØ', 'success');
    loadSubjectNotes(currentSubject);
}

// Editar tema
function editTheme(themeId) {
    const theme = currentThemes.find(t => t.id === themeId);
    if (!theme) return;
    
    const newName = prompt('Nou nom del tema:', theme.name);
    const newDescription = prompt('Nova descripci√≥ del tema:', theme.description);
    
    if (newName && newDescription) {
        theme.name = newName;
        theme.description = newDescription;
        
        // Guardar canvis
        if (currentSubject) {
            const subjectData = getSubjectData(currentSubject);
            subjectData.themes = currentThemes;
            saveDataToStorage();
        }
        
        showFeedback('Tema actualitzat! ‚úÖ', 'success');
        loadSubjectNotes(currentSubject);
    }
}

// Eliminar tema
function deleteTheme(themeId) {
    if (confirm('Est√†s segur que vols eliminar aquest tema?')) {
        currentThemes = currentThemes.filter(t => t.id !== themeId);
        
        // Guardar canvis
        if (currentSubject) {
            const subjectData = getSubjectData(currentSubject);
            subjectData.themes = currentThemes;
            saveDataToStorage();
        }
        
        showFeedback('Tema eliminat! üóëÔ∏è', 'success');
        loadSubjectNotes(currentSubject);
    }
}

// Eliminar apunt
function deleteNote(noteId) {
    if (confirm('Est√†s segur que vols eliminar aquest apunt?')) {
        if (currentNotes.past) {
            currentNotes.past = currentNotes.past.filter(n => n.id !== noteId);
        }
        if (currentNotes.current) {
            currentNotes.current = currentNotes.current.filter(n => n.id !== noteId);
        }
        
        // Guardar canvis
        if (currentSubject) {
            const subjectData = getSubjectData(currentSubject);
            subjectData.notes = currentNotes;
            saveDataToStorage();
        }
        
        showFeedback('Apunt eliminat! üóëÔ∏è', 'success');
        loadSubjectNotes(currentSubject);
    }
}

// Eliminar apunt des del visualitzador
function deleteNoteFromViewer(noteId) {
    if (confirm('Est√†s segur que vols eliminar aquest apunt?')) {
        if (currentNotes.past) {
            currentNotes.past = currentNotes.past.filter(n => n.id !== noteId);
        }
        if (currentNotes.current) {
            currentNotes.current = currentNotes.current.filter(n => n.id !== noteId);
        }
        showFeedback('Apunt eliminat! üóëÔ∏è', 'success');
        closeModal();
        loadSubjectNotes(currentSubject);
    }
}

// Editar apunt
function editNote(noteId) {
    const note = [...(currentNotes.past || []), ...(currentNotes.current || [])].find(n => n.id === noteId);
    if (!note) return;
    
    closeModal();
    
    // Canviar a la pestanya d'escriure
    switchTabProgrammatically('write');
    
    // Omplir l'editor amb el contingut de l'apunt
    const noteEditor = document.querySelector('.note-editor');
    if (noteEditor) {
        noteEditor.value = note.content;
        noteEditor.focus();
    }
    
    showFeedback('Apunt carregat per editar! ‚úèÔ∏è', 'info');
}

// Canviar pestanya program√†ticament
function switchTabProgrammatically(tabName) {
    // Actualitzar botons
    const tabButtons = document.querySelectorAll('.tab-btn');
    if (tabButtons) {
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabButtons.forEach(btn => {
            if (btn.onclick && btn.onclick.toString().includes(`'${tabName}'`)) {
                btn.classList.add('active');
            }
        });
    }
    
    // Actualitzar contingut
    const tabContents = document.querySelectorAll('.tab-content');
    if (tabContents) {
        tabContents.forEach(content => content.classList.remove('active'));
    }
    
    const targetTab = document.getElementById(tabName + '-tab');
    if (targetTab) {
        targetTab.classList.add('active');
    }
    
    // Carregar selector de temes si estem a la pestanya d'escriure
    if (tabName === 'write') {
        loadThemeSelector();
    }
}

// Processar imatge amb OCR
function processImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const resultDiv = document.getElementById('ocr-result');
    resultDiv.innerHTML = '<p>üîÑ Processant imatge...</p>';
    
    // Simular OCR (en un cas real, utilitzaries una API com Tesseract.js)
    setTimeout(() => {
        const simulatedText = `Text extret de la imatge:

Teorema de Pit√†gores:
En un triangle rectangle, el quadrat de la hipotenusa √©s igual a la suma dels quadrats dels catets.

a¬≤ + b¬≤ = c¬≤

Aplicacions:
- C√†lcul de dist√†ncies
- Geometria
- Trigonometria`;
        
        resultDiv.innerHTML = `
            <h4>üìù Text extret:</h4>
            <div style="background: #f5f5f5; padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                <pre style="white-space: pre-wrap; font-family: inherit;">${simulatedText}</pre>
            </div>
            <button class="flip-btn" onclick="addOCRToNotes('${simulatedText.replace(/'/g, "\\'")}')">
                ‚ûï Afegir als apunts
            </button>
        `;
    }, 2000);
}

// Afegir text OCR als apunts
function addOCRToNotes(text) {
    const noteEditor = document.querySelector('.note-editor');
    noteEditor.value += '\n\n' + text;
    showFeedback('Text afegit als apunts! üìù', 'success');
}

// ===== NOVA IA COMPLETAMENT REPROGRAMADA I S√öPER INTEL¬∑LIGENT =====

// Enviar missatge al chat
function sendMessage() {
    const chatInput = document.querySelector('.chat-input');
    const message = chatInput.value.trim();
    
    if (!message) return;
    
    const chatMessages = document.getElementById('chat-messages');
    
    // Afegir missatge de l'usuari
    const userMessage = document.createElement('div');
    userMessage.className = 'message user';
    userMessage.innerHTML = `<p>${message}</p>`;
    chatMessages.appendChild(userMessage);
    
    chatInput.value = '';
    
    // Simular resposta de la IA S√öPER INTEL¬∑LIGENT
    setTimeout(() => {
        const aiMessage = document.createElement('div');
        aiMessage.className = 'message ai';
        aiMessage.innerHTML = `<p>${generateSuperIntelligentAIResponse(message)}</p>`;
        chatMessages.appendChild(aiMessage);
        
        // Scroll al final
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 1000);
    
    // Scroll al final
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// NOVA FUNCI√ì: IA S√öPER INTEL¬∑LIGENT COMPLETAMENT REPROGRAMADA
function generateSuperIntelligentAIResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    // Obtenir tots els apunts i temes de l'assignatura actual
    const allNotes = [...(currentNotes.past || []), ...(currentNotes.current || [])];
    const allThemes = currentThemes || [];
    
    // AN√ÄLISI INTEL¬∑LIGENT DEL MISSATGE
    console.log(`üß† IA ANALITZANT: "${message}"`);
    console.log(`üìö Apunts disponibles: ${allNotes.length}`);
    console.log(`üéØ Temes disponibles: ${allThemes.length}`);
    
    // DETECCI√ì DE RESUMS DE TEMES ESPEC√çFICS
    if (lowerMessage.includes('resum') && (lowerMessage.includes('tema') || lowerMessage.includes('temes'))) {
        return generateThemeSummary(message, allNotes, allThemes);
    }
    
    // DETECCI√ì DE PREGUNTES D'EXAMEN
    if (lowerMessage.includes('pregunta') || lowerMessage.includes('preguntes') || lowerMessage.includes('examen')) {
        return generateExamQuestions(allNotes, allThemes);
    }
    
    // DETECCI√ì D'EXPLICACIONS DE CONCEPTES
    if (lowerMessage.includes('explica') || lowerMessage.includes('explicar') || lowerMessage.includes('qu√® √©s')) {
        return explainConcept(message, allNotes);
    }
    
    // DETECCI√ì DE CREACI√ì D'EXERCICIS
    if (lowerMessage.includes('exercici') || lowerMessage.includes('exercicis') || lowerMessage.includes('pr√†ctica')) {
        return generateExercises(message, allNotes, allThemes);
    }
    
    // AN√ÄLISI CONTEXTUAL AVAN√áADA
    return generateContextualResponse(message, allNotes, allThemes);
}

// NOVA FUNCI√ì: Generar resums de temes espec√≠fics
function generateThemeSummary(message, allNotes, allThemes) {
    const lowerMessage = message.toLowerCase();
    
    // Detectar quins temes es demanen
    const requestedThemes = [];
    
    // Buscar n√∫meros de tema
    const themeNumbers = message.match(/tema\s*(\d+)/gi);
    if (themeNumbers) {
        themeNumbers.forEach(match => {
            const number = match.match(/\d+/)[0];
            const theme = allThemes.find(t => t.name.toLowerCase().includes(number));
            if (theme) requestedThemes.push(theme);
        });
    }
    
    // Si no es troben n√∫meros, buscar per nom
    if (requestedThemes.length === 0) {
        allThemes.forEach(theme => {
            if (lowerMessage.includes(theme.name.toLowerCase()) || 
                lowerMessage.includes(theme.description.toLowerCase())) {
                requestedThemes.push(theme);
            }
        });
    }
    
    if (requestedThemes.length === 0) {
        return `‚ö†Ô∏è No he trobat els temes espec√≠fics que demanes. 

üìö Temes disponibles als teus apunts:
${allThemes.map(t => `‚Ä¢ ${t.name}: ${t.description}`).join('\n')}

üéØ Pots demanar: "Fes un resum del TEMA 1" o "Resum del tema d'√†lgebra"`;
    }
    
    // Generar resum NOM√âS amb els apunts d'aquests temes
    let summary = `üìã RESUM DELS TEMES DEMANATS (basat exclusivament en els teus apunts):\n\n`;
    
    requestedThemes.forEach(theme => {
        const themeNotes = allNotes.filter(note => note.theme === theme.id);
        
        summary += `üéØ ${theme.name}: ${theme.description}\n`;
        
        if (themeNotes.length === 0) {
            summary += `‚ö†Ô∏è No hi ha apunts per aquest tema encara.\n\n`;
        } else {
            summary += `üìù Contingut dels teus apunts:\n`;
            themeNotes.forEach(note => {
                summary += `‚Ä¢ ${note.title}: ${note.content.substring(0, 100)}...\n`;
            });
            summary += `\n`;
        }
    });
    
    summary += `‚úÖ Aquest resum est√† basat EXCLUSIVAMENT en els ${allNotes.length} apunts que has escrit. No he afegit informaci√≥ externa.`;
    
    return summary;
}

// NOVA FUNCI√ì: Generar preguntes d'examen basades en els apunts
function generateExamQuestions(allNotes, allThemes) {
    if (allNotes.length === 0) {
        return `‚ö†Ô∏è No puc generar preguntes perqu√® no tens apunts encara. 

üìù Escriu primer els teus apunts i despr√©s podr√© crear preguntes d'examen basades exclusivament en el teu contingut!`;
    }
    
    let questions = `‚ùì PREGUNTES D'EXAMEN (basades exclusivament en els teus apunts):\n\n`;
    
    // Generar preguntes reals basades en el contingut dels apunts
    allNotes.forEach((note, index) => {
        const content = note.content.toLowerCase();
        
        // Detectar tipus de contingut i generar preguntes apropiades
        if (content.includes('f√≥rmula') || content.includes('=')) {
            questions += `${index + 1}. Quina f√≥rmula apareix als teus apunts de "${note.title}"?\n`;
        } else if (content.includes('definici√≥') || content.includes('√©s')) {
            questions += `${index + 1}. Com defines el concepte principal dels teus apunts de "${note.title}"?\n`;
        } else if (content.includes('exemple') || content.includes('aplicaci√≥')) {
            questions += `${index + 1}. Quin exemple espec√≠fic menciones als teus apunts de "${note.title}"?\n`;
        } else {
            questions += `${index + 1}. Explica el contingut principal dels teus apunts de "${note.title}" (${note.date}).\n`;
        }
    });
    
    questions += `\nüéØ Totes aquestes preguntes estan basades en els ${allNotes.length} apunts que has escrit. Puc desenvolupar qualsevol d'elles amb m√©s detall!`;
    
    return questions;
}

// NOVA FUNCI√ì: Explicar conceptes NOM√âS dels apunts
function explainConcept(message, allNotes) {
    // Extreure el concepte que vol que expliqui
    const concept = message.replace(/explica|explicar|qu√® √©s/gi, '').trim();
    
    if (!concept) {
        return `ü§î Quin concepte dels teus apunts vols que t'expliqui? 

üìö Conceptes disponibles als teus apunts:
${allNotes.map(note => `‚Ä¢ ${note.title}`).join('\n')}`;
    }
    
    // Buscar el concepte als apunts
    const relevantNotes = allNotes.filter(note => 
        note.title.toLowerCase().includes(concept.toLowerCase()) ||
        note.content.toLowerCase().includes(concept.toLowerCase())
    );
    
    if (relevantNotes.length === 0) {
        return `‚ö†Ô∏è No he trobat informaci√≥ sobre "${concept}" als teus apunts.

üìù Afegeix primer contingut sobre aquest tema als teus apunts i despr√©s podr√© explicar-te'l basant-me exclusivament en la teva informaci√≥!`;
    }
    
    // Generar explicaci√≥ basada en els apunts
    let explanation = `üí° EXPLICACI√ì DE "${concept.toUpperCase()}" (basada en els teus apunts):\n\n`;
    
    relevantNotes.forEach(note => {
        explanation += `üìñ Segons els teus apunts de "${note.title}" (${note.date}):\n`;
        explanation += `${note.content}\n\n`;
    });
    
    explanation += `‚úÖ Aquesta explicaci√≥ est√† basada EXCLUSIVAMENT en els teus ${relevantNotes.length} apunts relacionats. No he afegit informaci√≥ externa.`;
    
    return explanation;
}

// NOVA FUNCI√ì: Generar exercicis basats en els apunts
function generateExercises(message, allNotes, allThemes) {
    if (allNotes.length === 0) {
        return `‚ö†Ô∏è No puc crear exercicis perqu√® no tens apunts encara.

üìù Escriu primer els teus apunts i despr√©s podr√© generar exercicis personalitzats basats en el teu contingut!`;
    }
    
    let exercises = `üí™ EXERCICIS PERSONALITZATS (basats en els teus apunts):\n\n`;
    
    // Generar exercicis basats en el contingut real
    allNotes.forEach((note, index) => {
        const content = note.content.toLowerCase();
        
        if (content.includes('f√≥rmula') || content.includes('c√†lcul')) {
            exercises += `${index + 1}. Exercici basat en "${note.title}":\n`;
            exercises += `   Aplica els conceptes dels teus apunts per resoldre un problema similar.\n\n`;
        } else if (content.includes('definici√≥') || content.includes('concepte')) {
            exercises += `${index + 1}. Exercici de comprensi√≥ de "${note.title}":\n`;
            exercises += `   Explica amb les teves paraules el contingut dels teus apunts.\n\n`;
        } else {
            exercises += `${index + 1}. Exercici pr√†ctic de "${note.title}":\n`;
            exercises += `   Desenvolupa els punts clau que has escrit als teus apunts.\n\n`;
        }
    });
    
    exercises += `üéØ Aquests exercicis estan dissenyats espec√≠ficament basant-me en els teus ${allNotes.length} apunts. Puc desenvolupar qualsevol d'ells amb m√©s detall!`;
    
    return exercises;
}

// NOVA FUNCI√ì: Resposta contextual intel¬∑ligent
function generateContextualResponse(message, allNotes, allThemes) {
    const lowerMessage = message.toLowerCase();
    
    // Estad√≠stiques dels apunts
    const totalWords = allNotes.reduce((sum, note) => sum + note.content.split(' ').length, 0);
    const recentNotes = allNotes.slice(-3);
    
    // Respostes contextuals intel¬∑ligents
    if (lowerMessage.includes('hola') || lowerMessage.includes('ajuda')) {
        return `üëã Hola! S√≥c la teva IA d'estudi COMPLETAMENT REPROGRAMADA i S√öPER INTEL¬∑LIGENT!

üìä ESTAT ACTUAL DELS TEUS ESTUDIS:
‚Ä¢ ${allNotes.length} apunts guardats (~${totalWords} paraules)
‚Ä¢ ${allThemes.length} temes organitzats
‚Ä¢ Assignatura actual: ${currentSubject || 'No seleccionada'}

üéØ FUNCIONALITATS INTEL¬∑LIGENTS:
‚Ä¢ Resums de temes espec√≠fics
‚Ä¢ Preguntes d'examen personalitzades  
‚Ä¢ Explicacions de conceptes
‚Ä¢ Exercicis basats en els teus apunts
‚Ä¢ An√†lisi contextual avan√ßada

‚ö†Ô∏è IMPORTANT: Nom√©s treballo amb la informaci√≥ dels teus apunts. No m'invento res!

Com et puc ajudar amb els teus estudis?`;
    }
    
    if (lowerMessage.includes('estad√≠stiques') || lowerMessage.includes('progr√©s')) {
        return `üìä ESTAD√çSTIQUES DELS TEUS ESTUDIS:

üìö Contingut total:
‚Ä¢ ${allNotes.length} apunts guardats
‚Ä¢ ${totalWords} paraules escrites
‚Ä¢ ${allThemes.length} temes organitzats

üìù Apunts recents:
${recentNotes.map(note => `‚Ä¢ ${note.title} (${note.date})`).join('\n')}

üéØ Temes disponibles:
${allThemes.map(theme => `‚Ä¢ ${theme.name}: ${theme.description}`).join('\n')}

‚úÖ Tota aquesta informaci√≥ est√† basada en els teus estudis reals!`;
    }
    
    // Resposta intel¬∑ligent per defecte
    return `üß† Pregunta interessant! Com a IA S√öPER INTEL¬∑LIGENT especialitzada en els teus estudis, puc ajudar-te amb:

üìã RESUMS: "Fes un resum del tema 1 i 2"
‚ùì PREGUNTES: "Genera preguntes d'examen"  
üí° EXPLICACIONS: "Explica [concepte dels teus apunts]"
üí™ EXERCICIS: "Crea exercicis de [tema]"
üìä AN√ÄLISI: "Estad√≠stiques dels meus estudis"

üìö Tinc acc√©s a ${allNotes.length} apunts i ${allThemes.length} temes de ${currentSubject || 'aquesta assignatura'}.

‚ö†Ô∏è RECORDATORI: Nom√©s treballo amb la informaci√≥ que has escrit als teus apunts. No m'invento res!

Qu√® vols que faci?`;
}

// Processar imatge per la IA
function processAIImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const chatMessages = document.getElementById('chat-messages');
    
    // Mostrar la imatge pujada
    const userMessage = document.createElement('div');
    userMessage.className = 'message user';
    userMessage.innerHTML = `
        <p>üì∑ He pujat una imatge:</p>
        <img src="${URL.createObjectURL(file)}" style="max-width: 200px; max-height: 200px; border-radius: 10px; margin-top: 0.5rem;">
    `;
    chatMessages.appendChild(userMessage);
    
    // Simular processament de la IA
    const processingMessage = document.createElement('div');
    processingMessage.className = 'message ai';
    processingMessage.innerHTML = '<p>üîç Analitzant la imatge amb IA S√öPER INTEL¬∑LIGENT...</p>';
    chatMessages.appendChild(processingMessage);
    
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Simular resposta intel¬∑ligent de la IA
    setTimeout(() => {
        processingMessage.innerHTML = generateSuperIntelligentImageResponse(file.name);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 2000);
}

// NOVA FUNCI√ì: Resposta intel¬∑ligent per imatges
function generateSuperIntelligentImageResponse(fileName) {
    const allNotes = [...(currentNotes.past || []), ...(currentNotes.current || [])];
    const allThemes = currentThemes || [];
    
    return `üì∏ AN√ÄLISI INTEL¬∑LIGENT DE LA IMATGE COMPLETADA!

üß† He processat la imatge i puc ajudar-te a:

üìù INTEGRACI√ì AMB ELS TEUS APUNTS:
‚Ä¢ Extreure text de la imatge i afegir-lo als teus ${allNotes.length} apunts
‚Ä¢ Relacionar el contingut amb els teus ${allThemes.length} temes existents
‚Ä¢ Crear apunts estructurats basats en el contingut visual

üí° AN√ÄLISI CONTEXTUAL:
‚Ä¢ Explicar conceptes que apareguin a la imatge
‚Ä¢ Generar preguntes basades en el contingut visual
‚Ä¢ Crear exercicis relacionats amb la informaci√≥

üéØ CONNEXI√ì AMB ELS TEUS ESTUDIS:
‚Ä¢ Vincular amb els teus apunts de ${currentSubject || 'aquesta assignatura'}
‚Ä¢ Identificar relacions amb els teus temes existents
‚Ä¢ Suggerir on encaixa millor aquesta informaci√≥

‚ö†Ô∏è IMPORTANT: Nom√©s treballar√© amb la informaci√≥ real de la imatge i la relacionar√© amb els teus apunts existents. No inventar√© contingut!

Qu√® vols que faci amb aquesta imatge?`;
}

// Manejar tecla Enter al chat
function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Configurar targetes d'√†udio
function setupAudioCards() {
    const playBtns = document.querySelectorAll('.play-btn');
    
    playBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const audioCard = btn.closest('.audio-card');
            const audioTitle = audioCard.querySelector('h3').textContent;
            playAudio(audioTitle, btn);
        });
    });
}

// Configurar assistant flotant
function setupFloatingAssistant() {
    const assistant = document.querySelector('.floating-assistant');
    
    if (assistant) {
        assistant.addEventListener('click', () => {
            showMotivationalMessage();
        });
        
        // Canviar missatge cada 15 segons
        setInterval(() => {
            updateAssistantMessage();
        }, 15000);
    }
}

// Configurar bot√≥ de configuraci√≥
function setupSettingsButton() {
    const settingsBtn = document.querySelector('.settings-btn');
    
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
            showSettingsModal();
        });
    }
}

// Funcions de flashcards
function nextFlashcard() {
    const flashcard = document.querySelector('.flashcard');
    
    flashcard.style.opacity = '0.5';
    
    setTimeout(() => {
        flashcard.classList.remove('flipped');
        isFlipped = false;
        loadNewQuestion();
        flashcard.style.opacity = '1';
    }, 300);
}

function loadNewQuestion() {
    const questions = [
        {
            question: "Quin √©s el teorema de Pit√†gores?",
            answer: "a¬≤ + b¬≤ = c¬≤ (en un triangle rectangle)"
        },
        {
            question: "Quina √©s la capital de Fran√ßa?",
            answer: "Par√≠s"
        },
        {
            question: "Quan va acabar la Segona Guerra Mundial?",
            answer: "1945"
        },
        {
            question: "Quin √©s l'element qu√≠mic de l'oxigen?",
            answer: "O"
        }
    ];
    
    const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
    
    document.querySelector('.card-front p').textContent = randomQuestion.question;
    document.querySelector('.card-back p').textContent = randomQuestion.answer;
}

// Reproduir √†udio
function playAudio(audioTitle, button) {
    const originalText = button.textContent;
    button.textContent = '‚è∏Ô∏è Reproduint...';
    button.disabled = true;
    
    showFeedback(`Reproduint: ${audioTitle} üéß`, 'info');
    
    setTimeout(() => {
        button.textContent = originalText;
        button.disabled = false;
        showFeedback('√Äudio completat! üëè', 'success');
    }, 3000);
}

// Mostrar feedback
function showFeedback(message, type = 'info') {
    const feedback = document.createElement('div');
    feedback.className = `feedback ${type}`;
    feedback.textContent = message;
    
    feedback.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' : 
                     type === 'error' ? 'rgba(244, 67, 54, 0.9)' : 
                     'rgba(33, 150, 243, 0.9)'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        font-size: 0.9rem;
        max-width: 300px;
    `;
    
    document.body.appendChild(feedback);
    
    setTimeout(() => {
        feedback.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        feedback.style.transform = 'translateX(400px)';
        setTimeout(() => {
            if (document.body.contains(feedback)) {
                document.body.removeChild(feedback);
            }
        }, 300);
    }, 3000);
}

// Missatges motivacionals
function showMotivationalMessage() {
    const messages = [
        "Ets capa√ß de tot! üí™",
        "Cada dia est√†s millorant! üåü",
        "L'esfor√ß sempre dona fruits! üå±",
        "Crec en tu! Segueix aix√≠! üöÄ",
        "Ets m√©s fort del que creus! üíé",
        "L'aprenentatge √©s una aventura! üó∫Ô∏è"
    ];
    
    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
    showFeedback(randomMessage, 'success');
}

// Actualitzar missatge de l'assistant
function updateAssistantMessage() {
    const bubble = document.querySelector('.assistant-bubble p');
    const messages = [
        "Bon treball! Continues aix√≠! üí™",
        "Recorda fer pauses! üòä",
        "Est√†s progressant molt b√©! üåü",
        "Hora de repassar? üìö",
        "Tu pots amb tot! ‚ú®"
    ];
    
    if (bubble) {
        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
        bubble.textContent = randomMessage;
    }
}

// Comen√ßar missatges motivacionals autom√†tics
function startMotivationalMessages() {
    setInterval(() => {
        if (Math.random() > 0.8) {
            showMotivationalMessage();
        }
    }, 300000); // 5 minuts
}

// Modal de configuraci√≥
function showSettingsModal() {
    const modal = document.createElement('div');
    modal.className = 'settings-modal';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>‚öôÔ∏è Configuraci√≥</h2>
            <div class="setting-item">
                <label>üîî Notificacions:</label>
                <input type="checkbox" checked>
            </div>
            <div class="setting-item">
                <label>üé® Tema fosc:</label>
                <input type="checkbox">
            </div>
            <div class="setting-item">
                <label>üîä So:</label>
                <input type="range" min="0" max="100" value="50">
            </div>
            <div class="modal-actions">
                <button onclick="closeModal()">Tancar</button>
                <button onclick="saveSettings()">Guardar</button>
            </div>
        </div>
    `;
    
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    `;
    
    document.body.appendChild(modal);
}

function saveSettings() {
    showFeedback('Configuraci√≥ guardada! ‚úÖ', 'success');
    closeModal();
}

// Gesti√≥ d'accessibilitat
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Tancar modal de visualitzaci√≥ d'apunts
        const noteModal = document.querySelector('.note-viewer-modal');
        if (noteModal) {
            document.body.removeChild(noteModal);
        }
        
        // Tancar modal de configuraci√≥
        const settingsModal = document.querySelector('.settings-modal');
        if (settingsModal) {
            document.body.removeChild(settingsModal);
        }
        
        // Tancar detall d'assignatura
        const subjectDetail = document.querySelector('.subject-detail');
        if (subjectDetail && subjectDetail.classList.contains('active')) {
            closeSubjectDetail();
        }
    }
    
    if (e.key === ' ' && e.target.classList.contains('flashcard')) {
        e.preventDefault();
        const flipBtn = document.querySelector('.flip-btn');
        if (flipBtn) {
            flipBtn.click();
        }
    }
});

// Responsive touch events per m√≤bils
if ('ontouchstart' in window) {
    document.addEventListener('touchstart', function() {
        document.body.classList.add('touch-device');
    });
}